<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Alarmeringen Amsterdam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    body { margin: 0; background: #111; }
    #map { height: 100vh; }
    .legend {
      background: rgba(20, 20, 20, 0.8);
      padding: 6px 8px;
      font: 12px sans-serif;
      border-radius: 5px;
      color: #eee;
    }
    .legend input {
      margin-right: 4px;
    }
    .leaflet-popup-content-wrapper {
      background: rgba(30, 30, 30, 0.9);
      color: #eee;
      font-family: sans-serif;
      font-size: 12px;
      border-radius: 6px;
    }
    .leaflet-popup-tip {
      background: rgba(30, 30, 30, 0.9);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    console.log("ðŸš€ Build version: clustering");

    const map = L.map('map').setView([52.37, 4.89], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(map);

    const dienstSettings = {
      'Politie': { color: [30, 144, 255] },     // blue rgba
      'Brandweer': { color: [255, 99, 71] },    // red rgba
      'Ambulance': { color: [255, 215, 0] },    // yellow rgba
      'Overig': { color: [169, 169, 169] }      // grey rgba
    };

    const layerGroups = {};
    const clusterGroups = {};

    for (const dienst in dienstSettings) {
      layerGroups[dienst] = L.layerGroup();
      clusterGroups[dienst] = L.markerClusterGroup({
        maxClusterRadius: 35,  // Tighter clustering (default ~80)
        iconCreateFunction: cluster => L.divIcon({
          html: `<div style="background:rgba(255,255,255,0.1);border:2px solid rgba(${dienstSettings[dienst].color.join(',')},1);border-radius:50%;width:30px;height:30px;line-height:30px;text-align:center;color:rgba(${dienstSettings[dienst].color.join(',')},1)">${cluster.getChildCount()}</div>`,
          className: 'marker-cluster',
          iconSize: [30, 30]
        })
      });
      layerGroups[dienst].
